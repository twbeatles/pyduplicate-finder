from PySide6.QtCore import QLocale
import os
from typing import ClassVar, Dict, Optional, Set

# Debug mode: set via environment variable
DEBUG_I18N = os.environ.get('DEBUG_I18N', '').lower() in ('1', 'true', 'yes')

class I18n:
    _instance: Optional["I18n"] = None
    _missing_keys: Set[str] = set()  # Track reported missing keys

    # Singleton state is effectively global; model as ClassVars for type checkers.
    current_lang: ClassVar[str] = "ko"
    translations: ClassVar[Dict[str, Dict[str, str]]] = {}
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super(I18n, cls).__new__(cls)
            cls.current_lang = "ko"  # Default
            cls.translations = {
                "en": {
                    "app_title": "PyDuplicate Finder Pro",
                    "scan_start": "Start Scan",
                    "scan_stop": "Stop",
                    "status_ready": "Ready",
                    "menu_file": "File",
                    "menu_help": "Help",
                    "menu_lang": "Language",
                    "btn_add_folder": "Add Folder",
                    "btn_add_drive": "Add Drive",
                    "btn_remove_folder": "Remove",
                    "btn_clear": "Clear",
                    "lbl_no_selection": "No location selected",
                    "grp_search_loc": "1. Search Location",
                    "grp_search_opt": "2. Search Options",
                    "lbl_ext": "Extensions (e.g., jpg, pdf):",
                    "ph_ext": "Leave empty for all",
                    "lbl_min_size": "Min File Size (KB):",
                    "chk_same_name": "Match content + filename",
                    "chk_byte_compare": "Byte-by-byte compare (100% accurate, slower)",
                    "chk_protect_system": "Protect System Folders (Exclude Windows/Program Files)",
                    "btn_start_scan": "Start Scan",
                    "col_path": "File Path / Group",
                    "col_size": "Size",
                    "col_mtime": "Modified Date",
                    "col_ext": "Ext",
                    "lbl_preview": "Preview",
                    "msg_select_file": "Select a file to preview",
                    "btn_smart_select": "Auto Select (Smart)",
                    "tip_smart_select": "Keeps the oldest file in each group.",
                    "btn_export": "Export Results (CSV)",
                    "btn_delete_selected": "Delete Selected (Undoable)",
                    "msg_no_files_selected": "No files selected.",
                    "confirm_delete_title": "Confirm Delete",
                    "confirm_delete_msg": "Delete {} files (Move to Trash)?\nYou can Undo this.",
                    "msg_delete_success": "{} files deleted. (Ctrl+Z to Undo)",
                    "msg_undo_complete": "Undo Complete.",
                    "msg_redo_complete": "Redo Complete: {} deleted again.",
                    "msg_scan_complete": "Done: {} duplicate groups found",
                    "err_no_folder": "Please add a folder or drive to scan.",
                    "err_save": "Error saving:\n{}",
                    "err_load": "Error loading:\n{}",
                    "ctx_open": "Open",
                    "ctx_open_folder": "Open Folder",
                    "ctx_copy_path": "Copy Path",
                    "file_open_dialog": "Select Folder",
                    "status_collecting_files": "Collecting files...",
                    "status_hashing": "Hashing...",
                    "status_hashing_progress": "Hashing ({}/{})",
                    "status_analyzing": "Analyzing candidates",
                    "status_undoing": "Undoing...",
                    "status_redoing": "Redoing...",
                    "status_byte_compare": "Byte comparing...",
                    "status_comparing": "Comparing...",
                    "status_found_images": "Found {} images, calculating hashes...",
                    "status_similar_image_scan": "Similar Image Scan",
                    "status_hashing_image": "Hashing images ({}/{})",
                    "status_grouping_images": "Grouping similar images ({}/{})",
                    "status_grouping": "Grouping...",
                    "status_done": "Done",
                    "status_stopped": "Stopped",
                    "status_stopping": "Stopping...",
                    "dlg_empty_title": "Empty Folder Finder",
                    "lbl_search_target": "Target: {} locations",
                    "btn_scan_empty": "Find Empty Folders",
                    "btn_delete_all": "Delete All",
                    "status_searching": "Searching...",
                    "status_search_done": "Done: {} found",
                    "confirm_empty_delete": "Delete {} empty folders?\nCannot be undone!",
                    "msg_empty_delete_result": "Deleted: {}.\nFailed: {}.",
                    "msg_n_folders_added": "{} folders added.",
                    "action_undo": "Undo",
                    "action_redo": "Redo",
                    "action_empty_finder": "Find Empty Folders",
                    "action_theme": "Dark Mode",
                    "msg_title_notice": "Notice",
                    "msg_add_folder_first": "Please add a search location first.",
                    "msg_delete_files_title": "Delete Files",
                    "msg_delete_files_confirm": "Delete {} files? (Move to Trash)",
                    "err_open_file": "Could not open file.",
                    "term_duplicate_group": "Duplicate Group",
                    "term_files": "files",
                    "term_name_group": "Name Group",
                    "term_size_varies": "Varies",
                    "err_unexpected": "An unexpected error occurred:\n{}",
                    "lang_ko": "Korean",
                    "lang_en": "English",
                    # New features
                    "chk_use_trash": "Use System Recycle Bin (No Undo)",
                    "chk_similar_image": "Find Similar Images (pHash)",
                    "chk_name_only": "Filename only (ignore content)",
                    "btn_exclude_patterns": "Exclude Patterns...",
                    "btn_include_patterns": "Include Patterns...",
                    "action_save_results": "Save Results",
                    "action_load_results": "Load Results",
                    "action_expand_all": "Expand All",
                    "action_collapse_all": "Collapse All",
                    "action_shortcut_settings": "Keyboard Shortcuts...",
                    "action_preset": "Presets",
                    "dlg_preset_title": "Scan Presets",
                    "dlg_exclude_title": "Exclude Patterns",
                    "dlg_shortcuts_title": "Keyboard Shortcuts",
                    "msg_file_locked": "Some files are in use and cannot be deleted:",
                    "msg_preset_saved": "Preset '{}' saved.",
                    "msg_results_saved": "Results saved to {}",
                    "msg_results_loaded": "Loaded {} groups from file",
                    "msg_results_summary": "Groups: {groups} • Files: {files} • Selected: {selected}",
                    "msg_no_results": "No results yet. Start a scan to see duplicates.",
                    "msg_filter_count": "Visible {visible}/{total}",
                    "msg_selected_count": "Selected: {count}",
                    "msg_filter_active": "Filter active",
                    "confirm_delete_selected_counts": "Selected: {total} (Visible: {visible})",
                    "msg_delete_includes_hidden": "Filter is active. All checked files will be deleted, including hidden items.",
                    "msg_total_size": "Estimated total size: {size}",
                    "msg_results_page_hint": "Results are shown on the Scan page. Go to Scan to review details.",
                    "btn_go_scan": "Go to Scan",
                    "btn_show_options": "Show Options",
                    "msg_tools_page_hint": "Maintenance tools that work on selected folders.",
                    "msg_tools_no_folders": "No folders selected yet. Go to Scan and add folders first.",
                    "msg_empty_finder_desc": "Find and delete empty folders in selected locations.",
                    "msg_settings_page_hint": "Customize appearance, shortcuts, and presets.",
                    "lbl_similarity_threshold": "Similarity Threshold:",
                    "tip_similar_image": "Finds visually similar images even if resized or recompressed",
                    "tip_same_name": "Compare only when both content and filename match",
                    "tip_name_only": "Ignore content and compare filenames only",
                    "tip_use_trash": "Files will be sent to the system Recycle Bin. Cannot undo!",
                    "btn_manage_presets": "Manage Presets...",
                    "err_shortcut_conflict": "This shortcut is already used by '{}'.",
                    "confirm_reset_shortcuts": "Reset all shortcuts to defaults?",
                    "action_start_scan": "Start Scan",
                    "action_stop_scan": "Stop Scan",
                    "action_delete": "Delete Selected",
                    "action_smart_select": "Smart Select",
                    "action_export": "Export CSV",
                    "msg_trash_warning": "Using system trash. Files will not be recoverable through this app!",
                    "lbl_filter_options": "Scan Options",
                    "hdr_filters_basic": "Basic Filters",
                    "hdr_filters_compare": "Comparison",
                    "hdr_filters_advanced": "Advanced",
                    "msg_scan_stage": "Stage: {stage}",
                    "confirm_trash_delete": "Delete {} files to Recycle Bin?\\nThis cannot be undone through this app.",
                    "confirm_delete_quarantine": "Delete {count} files (move to Quarantine)?\\nYou can Undo this.",
                    "err_operation_failed": "Operation failed or nothing done.",
                    "err_undo_failed": "Undo failed (Stack empty?)",
                    "err_redo_failed": "Redo failed.",
                    "err_preset_name": "Please enter a preset name.",
                    "err_preset_save": "Failed to save preset.",
                    "err_preset_load": "Failed to load preset.",
                    "err_preset_delete": "Failed to delete preset.",
                    "confirm_overwrite_preset": "Preset '{}' already exists. Overwrite?",
                    "confirm_delete_preset": "Delete preset '{}'?",
                    "confirm_clear_patterns": "Clear all patterns?",
                    "ph_preset_name": "Enter preset name...",
                    "btn_save_preset": "Save",
                    "btn_load_preset": "Load",
                    "btn_delete_preset": "Delete",
                    "btn_close": "Close",
                    "btn_add": "Add",
                    "btn_remove": "Remove Selected",
                    "btn_clear_all": "Clear All",
                    "btn_cancel": "Cancel",
                    "btn_ok": "OK",
                    "btn_clear_key": "Clear",
                    "btn_reset_defaults": "Reset to Defaults",
                    "lbl_exclude_desc": "Add patterns to exclude during scanning.\nMatches against filename and full path (fnmatch wildcards like * and ?).",
                    "lbl_include_desc": "Add patterns to include during scanning.\nIf set, only matching files are scanned (fnmatch wildcards like * and ?).",
                    "lbl_current_patterns": "Current Patterns",
                    "lbl_add_pattern": "Add Pattern",
                    "lbl_common_patterns": "Common:",
                    "lbl_shortcut_desc": "Click on a shortcut to edit it. Press the new key combination to change.",
                    "col_action": "Action",
                    "col_shortcut": "Shortcut",
                    "col_default": "Default",
                    "lbl_press_key": "Press keys:",
                    "ph_exclude_pattern": "e.g., *.log, node_modules, */temp/*",
                    "ph_include_pattern": "e.g., *.jpg, *.pdf, */Photos/*",

                    "dlg_include_title": "Include Patterns",

                    "chk_skip_hidden": "Skip hidden/system files",
                    "tip_skip_hidden": "Skips dotfiles and OS metadata (e.g., Thumbs.db, .DS_Store, desktop.ini)",
                    "chk_follow_symlinks": "Follow symlinks",
                    "tip_follow_symlinks": "Follows symbolic links (loop detection enabled)",
                    "chk_mixed_mode": "Mixed mode (duplicates + similar images)",
                    "tip_mixed_mode": "Runs duplicate-file detection and similar-image grouping in one scan",
                    "chk_detect_folder_dup": "Detect duplicate folders",
                    "tip_detect_folder_dup": "Detects folders with identical relative file structures and contents",
                    "chk_incremental_rescan": "Incremental rescan",
                    "tip_incremental_rescan": "Reuses previous completed scan snapshot and scans changed directories first",
                    "opt_select": "-- Select --",
                    
                    # New Features (Live Filter & Adv Select)
                    "ph_filter_results": "Filter results (name/path)...",
                    "action_select_newest": "Select Newest (Keep Oldest)",
                    "action_select_oldest": "Select Oldest (Keep Newest)",
                    "action_select_pattern": "Select by Pattern...",
                    "tip_select_newest": "Checks newer files for deletion, keeping the oldest file.",
                    "tip_select_oldest": "Checks older files for deletion, keeping the newest file.",
                    "ctx_select_pattern_title": "Select by Pattern",
                    "ctx_select_pattern_msg": "Enter text pattern to select (e.g. 'copy', '.tmp'):",
                    "msg_resume_scan": "A previous scan was interrupted. Resume it now?",
                    "btn_resume": "Resume",
                    "btn_new_scan": "New Scan",
                    "btn_later": "Later",
                    "msg_selected_pattern": "Selected {count} files matching '{pattern}'",
                    "msg_preview_folder": "Folder: {}",
                    "msg_rescan_recommended": "Rescan recommended for accurate results.",
                    "err_scan_failed": "Scan failed: {}",
                    "err_critical_title": "Critical Error",
                    "msg_preview_folder_hint": "Folder selected. Preview is available for files only.",
                    "msg_preview_unavailable": "Preview unavailable for this file type.",
                    "msg_preview_meta": "Size: {size} • Modified: {mtime}",
                    "msg_preview_meta_folder": "Folder",
                    "msg_preview_meta_unknown": "Unknown",
                    "badge_name_only": "Name-only",
                    "badge_similar": "Similar",
                    "badge_byte_compare": "Byte-compare",
                    "badge_folder_dup": "Folder duplicate",
                    "badge_missing": "Missing",
                    "badge_missing_count": "Missing: {count}",
                    "label_keep": "Keep: {name}",
                    "label_reclaim": "Reclaim: {size}",
                    "label_similar_group": "Similar #{id}",
                    "label_folder_dup_group": "Folder duplicate",
                    
                    # Navigation (Sidebar)
                    "nav_scan": "Scan",
                    "nav_results": "Results",
                    "nav_tools": "Tools",
                    "nav_settings": "Settings",
                    "sidebar_collapse": "◀ Collapse",
                    "sidebar_expand": "▶ Expand",
                    "sidebar_toggle_tooltip": "Collapse/Expand sidebar",
                    "btn_scan_options": "Options",
                    "msg_tools_no_locations": "No search locations selected. Go to Scan and add folders/drives to use tools.",
                    "msg_resume_scan_details": "Stage: {stage}\nLast update: {time}\n{message}",

                    # Quarantine / Rules / Operations
                    "tool_quarantine_title": "Quarantine",
                    "tool_quarantine_desc": "Files deleted with undoable mode are moved here. You can restore or permanently purge them.",
                    "ph_quarantine_search": "Search original path...",
                    "btn_refresh": "Refresh",
                    "btn_restore_selected": "Restore Selected",
                    "btn_purge_selected": "Purge Selected",
                    "btn_purge_all": "Purge All",
                    "col_created": "Created",
                    "col_status": "Status",
                    "tool_rules_title": "Selection Rules",
                    "tool_rules_desc": "Define ordered rules to keep or delete duplicates automatically (fnmatch wildcards like * and ?).",
                    "btn_edit_rules": "Edit Rules...",
                    "btn_apply_rules": "Auto Select (Rules)",
                    "btn_auto_select_rules": "Auto Select (Rules)",
                    "tool_ops_title": "Operations",
                    "btn_view_details": "View Details...",
                    "col_id": "ID",
                    "col_type": "Type",
                    "col_message": "Message",
                    "btn_hardlink_checked": "Hardlink Consolidate Checked (Advanced)",
                    "msg_hardlink_disabled": "Hardlink feature is disabled in Settings.",
                    "msg_no_rules": "No selection rules configured yet.",
                    "msg_no_items": "No items.",
                    "msg_retry_failed": "Retry failed items? ({})",
                    "msg_quarantine_disabled_fallback": "Quarantine is disabled. Falling back to system trash.",
                    "msg_quarantine_purged": "Quarantine purged: {} items",

                    # Operation result messages
                    "op_cancelled": "Cancelled",
                    "op_unknown_type": "Unknown op_type: {op_type}",
                    "op_quarantine_unavailable": "Quarantine manager unavailable",
                    "op_trash_unavailable": "System trash unavailable",
                    "op_canonical_missing": "Canonical missing",
                    "op_history_unavailable": "History manager unavailable",
                    "op_nothing_undo": "Nothing to undo",
                    "op_nothing_redo": "Nothing to redo",
                    "op_moved_quarantine": "Moved {ok}/{total} to quarantine",
                    "op_moved_trash": "Moved {ok}/{total} to system trash",
                    "op_restored": "Restored {ok}/{total}",
                    "op_purged": "Purged {ok}/{total}",
                    "op_hardlinked": "Hardlinked {ok}/{total}",

                    # Preflight
                    "dlg_preflight_title": "Preflight Report",
                    "msg_preflight_summary": "Eligible: {eligible} • Block: {blocks} • Warn: {warns} • Info: {infos}",
                    "btn_proceed": "Proceed",
                    "col_severity": "Severity",
                    "sev_block": "BLOCK",
                    "sev_warn": "WARN",
                    "sev_info": "INFO",
                    "status_working": "Working...",
                    "status_incremental_index": "Building incremental index",
                    "status_folder_dup": "Detecting duplicate folders",

                    # Preflight issue messages
                    "pf_missing": "Path does not exist",
                    "pf_is_dir": "Directories are not supported",
                    "pf_stat_failed": "Failed to read file metadata",
                    "pf_locked": "File appears to be in use",
                    "pf_no_eligible": "No eligible files to process",
                    "pf_disk_space": "Insufficient disk space in quarantine location (need ~{required} bytes free).",
                    "pf_not_quarantined": "Item is not quarantined",
                    "pf_missing_quarantine_file": "Quarantine file missing",
                    "pf_dest_exists": "Destination already exists (will restore with conflict name)",
                    "pf_no_eligible_restore": "No eligible items to restore",
                    "pf_missing_quarantine_file_purge": "Quarantine file missing (will mark purged)",
                    "pf_no_eligible_purge": "No eligible items to purge",
                    "pf_canonical_missing": "Canonical file missing",
                    "pf_target_missing": "Target missing",
                    "pf_cross_volume": "Hardlink requires same volume",
                    "pf_already_linked": "Already the same physical file",
                    "pf_no_eligible_hardlink": "No eligible targets to hardlink",

                    # Context (group)
                    "ctx_group_check_all": "Check All in Group",
                    "ctx_group_uncheck_all": "Uncheck All in Group",
                    "ctx_group_apply_rules": "Apply Rules to Group",
                    "ctx_group_hardlink": "Hardlink Consolidate Group",

                    # Rules dialog
                    "dlg_rules_title": "Selection Rules",
                    "msg_rules_desc": "Rules are applied in order. First match wins. Patterns match full path and filename.",
                    "col_pattern": "Pattern",
                    "rule_keep": "Keep",
                    "rule_delete": "Delete",
                    "ph_rule_pattern": "e.g., */downloads/*, *.tmp, * - copy*",
                    "ph_rule_test_path": "Test a path here...",
                    "btn_test_rule": "Test",
                    "btn_add_preset": "Add Preset",
                    "btn_up": "Up",
                    "btn_down": "Down",
                    "msg_rule_test_match": "Matched: {action} by pattern '{pattern}'",
                    "msg_rule_test_no_match": "No rule matched.",
                    "msg_rules_saved": "Rules saved.",

                    # Quarantine settings
                    "settings_quarantine_title": "Quarantine Settings",
                    "settings_quarantine_enabled": "Enable Quarantine (undoable deletes)",
                    "settings_quarantine_days": "Max age:",
                    "settings_quarantine_gb": "Max size:",
                    "term_days_suffix": " days",
                    "ph_quarantine_path": "Optional: custom quarantine folder",
                    "btn_choose_folder": "Choose Folder...",
                    "btn_apply": "Apply",
                    "msg_settings_applied": "Settings applied.",

                    # Cache/DB settings
                    "settings_cache_title": "Cache / Database",
                    "settings_cache_desc": "Scan cache database location (should be user-writable).",

                    # Hardlink settings
                    "settings_hardlink_title": "Hardlink Consolidation (Advanced)",
                    "settings_hardlink_enabled": "Enable hardlink consolidation",

                    # Purge confirms
                    "confirm_purge_items": "Permanently delete {} quarantined items? This cannot be undone.",
                    "confirm_purge_all": "Permanently delete ALL {} quarantined items? This cannot be undone.",

                    # Operation details dialog
                    "dlg_operation_details": "Operation Details",
                    "msg_operation_title": "Operation #{id} • {op_type} • {status} • {time}",
                    "col_action": "Action",
                    "col_result": "Result",
                    "col_detail": "Detail",
                    "col_quarantine_path": "Quarantine Path",
                    "btn_export_csv2": "Export CSV",
                    "btn_export_json": "Export JSON",
                    "msg_export_done": "Exported:\n{}",
                    "btn_undo_hardlink": "Undo Hardlink (Restore Originals)",
                },
                "ko": {
                    "app_title": "PyDuplicate Finder Pro",
                    "scan_start": "스캔 시작",
                    "scan_stop": "중지",
                    "status_ready": "준비됨",
                    "menu_file": "파일",
                    "menu_help": "도움말",
                    "menu_lang": "언어 (Language)",
                    "btn_add_folder": "폴더 추가",
                    "btn_add_drive": "드라이브 추가",
                    "btn_remove_folder": "제거",
                    "btn_clear": "초기화",
                    "lbl_no_selection": "선택된 위치 없음",
                    "grp_search_loc": "1. 검색 위치",
                    "grp_search_opt": "2. 검색 옵션",
                    "lbl_ext": "확장자 (예: jpg, pdf):",
                    "ph_ext": "비워두면 모든 파일",
                    "lbl_min_size": "최소 파일 크기 (KB):",
                    "chk_same_name": "내용 + 파일명 모두 일치",
                    "chk_byte_compare": "바이트 단위 정밀 비교 (100% 정확, 속도 느림)",
                    "chk_protect_system": "시스템 폴더 보호 (Windows/Program Files 등 제외)",
                    "btn_start_scan": "스캔 시작",
                    "col_path": "파일 경로 / 그룹",
                    "col_size": "크기",
                    "col_mtime": "수정 날짜",
                    "col_ext": "확장자",
                    "lbl_preview": "미리보기",
                    "msg_select_file": "파일을 선택하면 미리보기가 표시됩니다.",
                    "btn_smart_select": "자동 선택 (스마트)",
                    "tip_smart_select": "각 그룹에서 '수정 날짜가 가장 오래된' 파일을 원본으로 간주하고 남깁니다.",
                    "btn_export": "결과 내보내기 (CSV)",
                    "btn_delete_selected": "선택 항목 삭제 (Undo 가능)",
                    "msg_no_files_selected": "선택된 파일이 없습니다.",
                    "confirm_delete_title": "삭제 확인",
                    "confirm_delete_msg": "{}개의 파일을 삭제(임시 보관)하시겠습니까?\n'실행 취소'로 복구할 수 있습니다.",
                    "msg_delete_success": "{}개 파일 삭제됨. (Ctrl+Z로 취소 가능)",
                    "msg_undo_complete": "실행 취소 완료.",
                    "msg_redo_complete": "다시 실행 완료: {}개 재삭제됨.",
                    "msg_scan_complete": "완료: {}개의 중복 그룹 발견",
                    "err_no_folder": "검색할 폴더나 드라이브를 추가해주세요.",
                    "err_save": "저장 중 오류가 발생했습니다:\n{}",
                    "err_load": "불러오기 중 오류가 발생했습니다:\n{}",
                    "ctx_open": "열기",
                    "ctx_open_folder": "폴더 열기",
                    "ctx_copy_path": "경로 복사",
                    "file_open_dialog": "폴더 선택",
                    "status_collecting_files": "파일 목록 수집 중...",
                    "status_hashing": "해시 계산 중...",
                    "status_hashing_progress": "해시 계산 중 ({}/{})",
                    "status_analyzing": "정밀 분석 대상",
                    "status_undoing": "실행 취소 중...",
                    "status_redoing": "다시 실행 중...",
                    "status_byte_compare": "바이트 정밀 비교 중...",
                    "status_comparing": "비교 중...",
                    "status_found_images": "{}개 이미지 발견, 해시 계산 중...",
                    "status_similar_image_scan": "유사 이미지 스캔",
                    "status_hashing_image": "이미지 해시 계산 중 ({}/{})",
                    "status_grouping_images": "유사 이미지 그룹핑 중 ({}/{})",
                    "status_grouping": "그룹핑 중...",
                    "status_done": "완료",
                    "status_stopped": "중지됨",
                    "status_stopping": "중지 중...",
                    "dlg_empty_title": "빈 폴더 정리기",
                    "lbl_search_target": "검색 대상: {}개 위치",
                    "btn_scan_empty": "빈 폴더 검색",
                    "btn_delete_all": "전체 삭제",
                    "status_searching": "검색 중...",
                    "status_search_done": "검색 완료: {}개 발견",
                    "confirm_empty_delete": "{}개의 빈 폴더를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다!",
                    "msg_empty_delete_result": "{}개 삭제 완료.\n{}개 실패.",
                    "msg_n_folders_added": "{}개 폴더가 추가되었습니다.",
                    "action_undo": "실행 취소 (Undo)",
                    "action_redo": "다시 실행 (Redo)",
                    "action_empty_finder": "빈 폴더 찾기",
                    "action_theme": "다크 모드",
                    "msg_title_notice": "알림",
                    "msg_add_folder_first": "먼저 검색할 위치를 추가해주세요.",
                    "msg_delete_files_title": "파일 삭제",
                    "msg_delete_files_confirm": "{}개의 파일을 삭제하시겠습니까? (휴지통 이동)",
                    "err_open_file": "파일을 열 수 없습니다.",
                    "term_duplicate_group": "중복 그룹",
                    "term_files": "파일",
                    "term_name_group": "파일명 그룹",
                    "term_size_varies": "크기 다양",
                    "err_unexpected": "알 수 없는 오류가 발생했습니다:\n{}",
                    "lang_ko": "한국어",
                    "lang_en": "English",
                    # New features
                    "chk_use_trash": "시스템 휴지통 사용 (Undo 불가)",
                    "chk_similar_image": "유사 이미지 찾기 (pHash)",
                    "chk_name_only": "파일명만 비교 (내용 무시)",
                    "btn_exclude_patterns": "제외 패턴 설정...",
                    "btn_include_patterns": "포함 패턴 설정...",
                    "action_save_results": "결과 저장",
                    "action_load_results": "결과 불러오기",
                    "action_expand_all": "모두 펼치기",
                    "action_collapse_all": "모두 접기",
                    "action_shortcut_settings": "단축키 설정...",
                    "action_preset": "프리셋",
                    "dlg_preset_title": "스캔 프리셋",
                    "dlg_exclude_title": "제외 패턴",
                    "dlg_shortcuts_title": "단축키 설정",
                    "msg_file_locked": "일부 파일이 사용 중이어서 삭제할 수 없습니다:",
                    "msg_preset_saved": "프리셋 '{}'이(가) 저장되었습니다.",
                    "msg_results_saved": "결과가 {}에 저장되었습니다.",
                    "msg_results_loaded": "{}개 그룹을 파일에서 불러왔습니다.",
                    "msg_results_summary": "그룹: {groups} • 파일: {files} • 선택: {selected}",
                    "msg_no_results": "아직 결과가 없습니다. 스캔을 시작하세요.",
                    "msg_filter_count": "표시 {visible}/{total}",
                    "msg_selected_count": "선택: {count}",
                    "msg_filter_active": "필터 적용 중",
                    "confirm_delete_selected_counts": "선택: {total} (표시: {visible})",
                    "msg_delete_includes_hidden": "필터가 적용되어 있습니다. 숨겨진 항목을 포함해 체크된 모든 파일이 삭제됩니다.",
                    "msg_total_size": "예상 총 용량: {size}",
                    "msg_results_page_hint": "결과는 스캔 페이지에 표시됩니다. 자세히 보려면 스캔으로 이동하세요.",
                    "btn_go_scan": "스캔으로 이동",
                    "msg_tools_page_hint": "선택한 폴더에 적용되는 유지 관리 도구입니다.",
                    "msg_tools_no_folders": "선택된 폴더가 없습니다. 스캔에서 폴더를 먼저 추가하세요.",
                    "btn_show_options": "옵션 보기",
                    "msg_empty_finder_desc": "선택한 위치에서 빈 폴더를 찾아 삭제합니다.",
                    "msg_settings_page_hint": "테마, 단축키, 프리셋을 설정하세요.",
                    "lbl_similarity_threshold": "유사도 임계값:",
                    "tip_similar_image": "리사이즈되거나 재압축된 이미지도 시각적으로 유사하면 찾습니다",
                    "tip_same_name": "내용과 파일명이 모두 같은 경우만 비교합니다",
                    "tip_name_only": "내용은 무시하고 파일명만 비교합니다",
                    "tip_use_trash": "파일이 시스템 휴지통으로 이동됩니다. 취소할 수 없습니다!",
                    "btn_manage_presets": "프리셋 관리...",
                    "btn_ok": "확인",
                    "lbl_exclude_desc": "스캔 시 제외할 패턴을 추가합니다.\\n파일명/전체 경로에 대해 fnmatch 와일드카드(*, ?)로 매칭합니다.",
                    "lbl_include_desc": "스캔 시 포함할 패턴을 추가합니다.\\n설정 시, 해당 패턴과 매칭되는 파일만 스캔합니다 (fnmatch 와일드카드 * / ?).",
                    "lbl_current_patterns": "현재 패턴",
                    "lbl_add_pattern": "패턴 추가",
                    "lbl_common_patterns": "일반 패턴:",
                    "confirm_clear_patterns": "모든 패턴을 삭제할까요?",
                    "lbl_shortcut_desc": "단축키를 클릭하여 편집합니다. 새 키 조합을 눌러 변경하세요.",
                    "col_action": "기능",
                    "col_shortcut": "단축키",
                    "ph_exclude_pattern": "예: *.log, node_modules, */temp/*",
                    "ph_include_pattern": "예: *.jpg, *.pdf, */Photos/*",

                    "dlg_include_title": "포함 패턴",

                    "chk_skip_hidden": "숨김/시스템 파일 제외",
                    "tip_skip_hidden": "점(.)으로 시작하는 파일/폴더와 OS 메타데이터(Thumbs.db, .DS_Store, desktop.ini 등)를 제외합니다",
                    "chk_follow_symlinks": "심볼릭 링크 따라가기",
                    "tip_follow_symlinks": "심볼릭 링크를 따라 스캔합니다 (루프 감지 포함)",
                    "chk_mixed_mode": "혼합 모드 (중복 + 유사 이미지)",
                    "tip_mixed_mode": "한 번의 스캔에서 일반 중복 탐지와 유사 이미지 그룹핑을 함께 실행합니다",
                    "chk_detect_folder_dup": "중복 폴더 탐지",
                    "tip_detect_folder_dup": "상대 경로 구조와 파일 내용이 같은 폴더를 탐지합니다",
                    "chk_incremental_rescan": "증분 재스캔",
                    "tip_incremental_rescan": "이전 완료 세션 스냅샷을 활용해 변경된 디렉터리부터 우선 스캔합니다",
                    "opt_select": "-- 선택 --",
                    "btn_clear_key": "지우기",
                    "btn_reset_defaults": "기본값으로 복원",
                    "err_shortcut_conflict": "이 단축키는 이미 '{}'에서 사용 중입니다.",
                    "confirm_reset_shortcuts": "모든 단축키를 기본값으로 복원할까요?",
                    "action_start_scan": "스캔 시작",
                    "action_stop_scan": "스캔 중지",
                    "action_delete": "선택 삭제",
                    "action_smart_select": "스마트 선택",
                    "action_export": "CSV 내보내기",
                    "msg_trash_warning": "시스템 휴지통을 사용합니다. 이 앱을 통해 복구할 수 없습니다!",
                    "lbl_filter_options": "스캔 옵션",
                    "hdr_filters_basic": "기본 필터",
                    "hdr_filters_compare": "비교 방식",
                    "hdr_filters_advanced": "고급 옵션",
                    "msg_scan_stage": "단계: {stage}",
                    "confirm_trash_delete": "{}개의 파일을 휴지통으로 이동할까요?\\n이 앱을 통해 취소할 수 없습니다.",
                    "confirm_delete_quarantine": "{count}개의 파일을 격리함으로 이동할까요?\\nUndo로 되돌릴 수 있습니다.",
                    "err_operation_failed": "작업이 실패했거나 수행된 작업이 없습니다.",
                    "err_undo_failed": "실행 취소 실패 (스택이 비어있음?)",
                    "err_redo_failed": "다시 실행 실패.",
                    "err_preset_name": "프리셋 이름을 입력해주세요.",
                    "err_preset_save": "프리셋 저장에 실패했습니다.",
                    "err_preset_load": "프리셋 불러오기에 실패했습니다.",
                    "err_preset_delete": "프리셋 삭제에 실패했습니다.",
                    "confirm_overwrite_preset": "프리셋 '{}'이(가) 이미 존재합니다. 덮어쓸까요?",
                    "confirm_delete_preset": "프리셋 '{}'을(를) 삭제할까요?",
                    "ph_preset_name": "프리셋 이름 입력...",
                    "btn_save_preset": "저장",
                    "btn_load_preset": "불러오기",
                    "btn_delete_preset": "삭제",
                    "btn_close": "닫기",
                    "btn_add": "추가",
                    "btn_remove": "선택 삭제",
                    "btn_clear_all": "모두 삭제",
                    "btn_cancel": "취소",
                    "col_default": "기본값",
                    "lbl_press_key": "키 입력:",
                    
                    # New Features (Live Filter & Adv Select)
                    "ph_filter_results": "결과 필터링 (이름/경로)...",
                    "action_select_newest": "최신 항목 선택 (오래된 것 보존)",
                    "action_select_oldest": "오래된 항목 선택 (최신 것 보존)",
                    "action_select_pattern": "패턴으로 선택...",
                    "tip_select_newest": "최신 파일을 삭제 대상으로 선택하고, 가장 오래된 파일을 보존합니다.",
                    "tip_select_oldest": "오래된 파일을 삭제 대상으로 선택하고, 가장 최신 파일을 보존합니다.",
                    "ctx_select_pattern_title": "패턴으로 선택",
                    "ctx_select_pattern_msg": "선택할 텍스트 패턴 입력 (예: 'copy', '.tmp'):",
                    "msg_resume_scan": "이전에 중단된 스캔이 있습니다. 이어서 진행할까요?",
                    "btn_resume": "이어하기",
                    "btn_new_scan": "새 스캔",
                    "btn_later": "나중에",
                    "msg_selected_pattern": "패턴 '{pattern}'과(와) 일치하는 {count}개 파일을 선택했습니다.",
                    "msg_preview_folder": "폴더: {}",
                    "msg_rescan_recommended": "정확한 결과를 위해 재스캔을 권장합니다.",
                    "err_scan_failed": "스캔 실패: {}",
                    "err_critical_title": "치명적 오류",
                    "msg_preview_folder_hint": "폴더가 선택되었습니다. 미리보기는 파일만 지원합니다.",
                    "msg_preview_unavailable": "이 파일 형식은 미리보기를 지원하지 않습니다.",
                    "msg_preview_meta": "크기: {size} • 수정: {mtime}",
                    "msg_preview_meta_folder": "폴더",
                    "msg_preview_meta_unknown": "알 수 없음",
                    "badge_name_only": "파일명",
                    "badge_similar": "유사 이미지",
                    "badge_byte_compare": "바이트 비교",
                    "badge_folder_dup": "폴더 중복",
                    "badge_missing": "누락",
                    "badge_missing_count": "누락: {count}",
                    "label_keep": "보존: {name}",
                    "label_reclaim": "회수: {size}",
                    "label_similar_group": "유사 #{id}",
                    "label_folder_dup_group": "폴더 중복",
                    
                    # Navigation (Sidebar)
                    "nav_scan": "스캔",
                    "nav_results": "결과",
                    "nav_tools": "도구",
                    "nav_settings": "설정",
                    "sidebar_collapse": "◀ 접기",
                    "sidebar_expand": "▶ 펼치기",
                    "sidebar_toggle_tooltip": "사이드바 접기/펼치기",
                    "btn_scan_options": "옵션",
                    "msg_tools_no_locations": "검색 위치가 없습니다. 스캔으로 이동해 폴더/드라이브를 추가한 뒤 도구를 사용하세요.",
                    "msg_resume_scan_details": "단계: {stage}\n마지막 업데이트: {time}\n{message}",

                    # Quarantine / Rules / Operations
                    "tool_quarantine_title": "격리함",
                    "tool_quarantine_desc": "Undo 가능한 삭제 모드로 삭제된 파일이 이곳으로 이동합니다. 복구하거나 영구 삭제할 수 있습니다.",
                    "ph_quarantine_search": "원본 경로 검색...",
                    "btn_refresh": "새로고침",
                    "btn_restore_selected": "선택 복구",
                    "btn_purge_selected": "선택 영구삭제",
                    "btn_purge_all": "모두 영구삭제",
                    "col_created": "생성 시간",
                    "col_status": "상태",
                    "tool_rules_title": "자동 선택 규칙",
                    "tool_rules_desc": "중복 파일을 자동으로 선택하기 위한 규칙을 설정합니다 (fnmatch 와일드카드 * / ?).",
                    "btn_edit_rules": "규칙 편집...",
                    "btn_apply_rules": "자동 선택 (규칙)",
                    "btn_auto_select_rules": "자동 선택 (규칙)",
                    "tool_ops_title": "작업 기록",
                    "btn_view_details": "상세 보기...",
                    "col_id": "ID",
                    "col_type": "유형",
                    "col_message": "메시지",
                    "btn_hardlink_checked": "하드링크 통합 (고급)",
                    "msg_hardlink_disabled": "설정에서 하드링크 기능이 비활성화되어 있습니다.",
                    "msg_no_rules": "설정된 규칙이 없습니다.",
                    "msg_no_items": "항목이 없습니다.",
                    "msg_retry_failed": "실패한 항목을 재시도할까요? ({})",
                    "msg_quarantine_disabled_fallback": "격리함이 비활성화되어 휴지통으로 대체합니다.",
                    "msg_quarantine_purged": "격리함 정리: {}개",

                    # Operation result messages
                    "op_cancelled": "취소됨",
                    "op_unknown_type": "알 수 없는 작업 유형: {op_type}",
                    "op_quarantine_unavailable": "격리함을 사용할 수 없습니다",
                    "op_trash_unavailable": "시스템 휴지통을 사용할 수 없습니다",
                    "op_canonical_missing": "기준 파일이 없습니다",
                    "op_history_unavailable": "Undo/Redo를 사용할 수 없습니다",
                    "op_nothing_undo": "되돌릴 작업이 없습니다",
                    "op_nothing_redo": "다시 실행할 작업이 없습니다",
                    "op_moved_quarantine": "격리함으로 이동: {ok}/{total}",
                    "op_moved_trash": "휴지통으로 이동: {ok}/{total}",
                    "op_restored": "복구: {ok}/{total}",
                    "op_purged": "영구삭제: {ok}/{total}",
                    "op_hardlinked": "하드링크 통합: {ok}/{total}",

                    # Preflight
                    "dlg_preflight_title": "사전 점검",
                    "msg_preflight_summary": "대상: {eligible} • 차단: {blocks} • 경고: {warns} • 정보: {infos}",
                    "btn_proceed": "계속",
                    "col_severity": "중요도",
                    "sev_block": "차단",
                    "sev_warn": "경고",
                    "sev_info": "정보",
                    "status_working": "작업 중...",
                    "status_incremental_index": "증분 인덱스 구성 중",
                    "status_folder_dup": "중복 폴더 탐지 중",

                    # Preflight issue messages
                    "pf_missing": "경로가 존재하지 않습니다",
                    "pf_is_dir": "폴더는 지원하지 않습니다",
                    "pf_stat_failed": "파일 정보를 읽을 수 없습니다",
                    "pf_locked": "파일이 사용 중인 것으로 보입니다",
                    "pf_no_eligible": "처리 가능한 파일이 없습니다",
                    "pf_disk_space": "격리함 위치의 디스크 공간이 부족합니다 (약 {required} bytes 필요).",
                    "pf_not_quarantined": "격리된 항목이 아닙니다",
                    "pf_missing_quarantine_file": "격리 파일이 없습니다",
                    "pf_dest_exists": "대상 경로에 파일이 이미 존재합니다 (충돌 이름으로 복구됩니다)",
                    "pf_no_eligible_restore": "복구 가능한 항목이 없습니다",
                    "pf_missing_quarantine_file_purge": "격리 파일이 없습니다 (정리됨으로 표시)",
                    "pf_no_eligible_purge": "영구삭제 가능한 항목이 없습니다",
                    "pf_canonical_missing": "기준 파일이 존재하지 않습니다",
                    "pf_target_missing": "대상 파일이 없습니다",
                    "pf_cross_volume": "하드링크는 같은 드라이브/볼륨에서만 가능합니다",
                    "pf_already_linked": "이미 같은 물리 파일입니다",
                    "pf_no_eligible_hardlink": "하드링크로 통합할 대상이 없습니다",

                    # Context (group)
                    "ctx_group_check_all": "그룹 전체 선택",
                    "ctx_group_uncheck_all": "그룹 전체 해제",
                    "ctx_group_apply_rules": "그룹에 규칙 적용",
                    "ctx_group_hardlink": "그룹 하드링크 통합",

                    # Rules dialog
                    "dlg_rules_title": "자동 선택 규칙",
                    "msg_rules_desc": "규칙은 위에서 아래 순서로 적용되며, 첫 번째로 매칭된 규칙이 적용됩니다.",
                    "col_pattern": "패턴",
                    "rule_keep": "보존",
                    "rule_delete": "삭제",
                    "ph_rule_pattern": "예: */downloads/*, *.tmp, * - copy*",
                    "ph_rule_test_path": "여기에 테스트할 경로 입력...",
                    "btn_test_rule": "테스트",
                    "btn_add_preset": "프리셋 추가",
                    "btn_up": "위로",
                    "btn_down": "아래로",
                    "msg_rule_test_match": "매칭됨: {action} (패턴: '{pattern}')",
                    "msg_rule_test_no_match": "매칭된 규칙이 없습니다.",
                    "msg_rules_saved": "규칙이 저장되었습니다.",

                    # Quarantine settings
                    "settings_quarantine_title": "격리함 설정",
                    "settings_quarantine_enabled": "격리함 사용 (Undo 가능한 삭제)",
                    "settings_quarantine_days": "최대 보관 기간:",
                    "settings_quarantine_gb": "최대 용량:",
                    "term_days_suffix": "일",
                    "ph_quarantine_path": "선택: 격리함 경로 지정",
                    "btn_choose_folder": "폴더 선택...",
                    "btn_apply": "적용",
                    "msg_settings_applied": "설정이 적용되었습니다.",

                    # Cache/DB settings
                    "settings_cache_title": "캐시 / DB",
                    "settings_cache_desc": "스캔 캐시 DB 저장 위치 (사용자 쓰기 가능 경로 권장).",

                    # Hardlink settings
                    "settings_hardlink_title": "하드링크 통합 (고급)",
                    "settings_hardlink_enabled": "하드링크 통합 사용",

                    # Purge confirms
                    "confirm_purge_items": "격리함 항목 {}개를 영구 삭제할까요? 되돌릴 수 없습니다.",
                    "confirm_purge_all": "격리함 항목 전체 {}개를 영구 삭제할까요? 되돌릴 수 없습니다.",

                    # Operation details dialog
                    "dlg_operation_details": "작업 상세",
                    "msg_operation_title": "작업 #{id} • {op_type} • {status} • {time}",
                    "col_action": "작업",
                    "col_result": "결과",
                    "col_detail": "상세",
                    "col_quarantine_path": "격리 경로",
                    "btn_export_csv2": "CSV 내보내기",
                    "btn_export_json": "JSON 내보내기",
                    "msg_export_done": "내보내기 완료:\n{}",
                    "btn_undo_hardlink": "하드링크 되돌리기 (원본 복구)",
                }
            }
        return cls._instance

    def set_language(self, lang_code):
        if lang_code in type(self).translations:
            type(self).current_lang = lang_code
        else:
            type(self).current_lang = "en"  # Fallback

    def tr(self, key):
        result = type(self).translations.get(type(self).current_lang, {}).get(key)
        if result is None:
            # Fallback to English
            result = type(self).translations.get("en", {}).get(key)
            
        if result is None:
            # Log missing key in debug mode
            if DEBUG_I18N and key not in I18n._missing_keys:
                I18n._missing_keys.add(key)
                print(f"[i18n] Missing translation key: '{key}' (lang={self.current_lang})")
            return f"[{key}]" if DEBUG_I18N else key
        
        return result
    
    @classmethod
    def get_missing_keys(cls):
        """Returns set of all missing translation keys encountered."""
        return cls._missing_keys.copy()

# Blender-style singleton access
strings = I18n()

